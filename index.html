<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible App — Lazy + TTS</title>
<link rel="icon" type="image/png" href="A_2D_digital_vector_illustration_features_a_Bible_.png">
<style>
  :root{--primary:#007aff;--border:#e6e6e6;--panel:#fafafa}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#fff;color:#111;padding:16px}
  .wrap{max-width:1180px;margin:0 auto;background:#f7f7fb;border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:700}
  nav{display:flex;gap:8px}
  .nav-btn{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:transparent;cursor:pointer;font-weight:600}
  .nav-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
  .page{display:none}
  .page.active{display:block}
  .home-title{text-align:center;padding:80px 0;font-size:28px;font-weight:700}
  .top-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select{padding:10px 34px 10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;appearance:none;cursor:pointer}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
  .reader{display:grid;grid-template-columns:260px 1fr;gap:14px;margin-top:12px}
  .panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid var(--border);min-height:360px}
  #chaptersList,#versesList{overflow:auto;padding-right:6px;max-height:560px}
  .chapter-item{padding:10px;border-radius:8px;margin-bottom:6px;cursor:pointer;font-family:Georgia,serif}
  .chapter-item.active{background:var(--primary);color:#fff}
  .verse{padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;font-family:"Times New Roman",serif;font-size:18px;line-height:1.45}
  .vnum{font-weight:700;margin-right:8px}
  #audioBar{display:flex;gap:8px;margin-left:auto}
  .small{font-size:13px;color:#666}
  .loadingOverlay{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,0.6);z-index:9999}
  .loadingOverlay.show{display:flex}
  .loader{padding:12px 18px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .search-input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px}
  @media (max-width:900px){ .reader{grid-template-columns:1fr} #chaptersList,#versesList{max-height:260px} }
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Bible App">
    <header>
      <div class="brand">
        <div class="logo"><img src="A_2D_digital_vector_illustration_features_a_Bible_.jpg" alt="icon"></div>
        <div>
          <div class="title">Bible App</div>
          <div class="small">Fast lazy-loading with TTS</div>
        </div>
      </div>

      <nav aria-label="Main navigation">
        <button class="nav-btn active" data-page="home">Home</button>
        <button class="nav-btn" data-page="reader">Reader</button>
        <button class="nav-btn" data-page="search">Search</button>
      </nav>
    </header>

    <!-- HOME -->
    <section id="home" class="page active">
      <div class="home-title">Welcome to the Bible App</div>
    </section>

    <!-- READER -->
    <section id="reader" class="page" aria-label="Reader">
      <div class="top-row">
        <select id="versionSelect" aria-label="Version"></select>
        <select id="bookSelect" aria-label="Book"></select>
        <button class="btn" id="fontUp">A+</button>
        <button class="btn" id="fontDown">A−</button>

        <div id="audioBar">
          <button class="btn" id="playBtn">Play</button>
          <button class="btn" id="pauseBtn">Pause</button>
          <button class="btn" id="resumeBtn">Resume</button>
          <button class="btn" id="stopBtn">Stop</button>
        </div>
      </div>

      <div class="reader">
        <aside class="panel">
          <h3>Chapters</h3>
          <div id="chaptersList" role="list"></div>
        </aside>

        <section class="panel">
          <h3>Verses</h3>
          <div id="versesList" role="list"></div>
        </section>
      </div>
    </section>

    <!-- SEARCH -->
    <section id="search" class="page panel" aria-label="Search">
      <h3>Search</h3>
      <input id="searchInput" class="search-input" placeholder="Search words or reference (e.g. John 3:16)">
      <div id="searchResults"></div>
    </section>
  </div>

  <div class="loadingOverlay" id="loadingOverlay" aria-hidden="true">
    <div class="loader" role="status">Loading version…</div>
  </div>

<script>
/* =========================
   Version file map (short names)
   Ensure these files exist beside this HTML
   ========================= */
const VERSION_FILES = {
  // English
  AMP: 'AMP_bible.json',
  CSB: 'CSB_bible.json',
  ESV: 'ESV_bible.json',
  KJV: 'KJV_bible.json',
  NKJV: 'NKJV_bible.json',
  NIV: 'NIV_bible.json',
  NLT: 'NLT_bible.json',

  // Indian languages
  Bengali: 'bengali_bible.json',
  Gujarati: 'gujarati_bible.json',
  Hindi: 'hindi_bible.json',
  Kannada: 'kannada_bible.json',
  Malayalam: 'malayalam_bible.json',
  Nepali: 'nepali_bible.json',
  Odia: 'odia_bible.json',
  Punjabi: 'punjabi_bible.json',
  Tamil: 'tamil_bible.json',
  Telugu: 'telugu_bible.json',

  // Other languages
  Afrikaans: 'afrikaans_bible.json',
  Hungarian: 'hungarian_bible.json',
  Indonesian: 'indonesian_bible.json',
  Sepedi: 'sepedi_bible.json',
  Xhosa: 'xhosa_bible.json',
  Zulu: 'zulu_bible.json'
};

/* ---------------- State & caches ---------------- */
const loaded = {};        // loaded[version] = parsed JSON
const cacheBooks = {};    // cacheBooks[version] = [ [bookName,bookData], ... ]
const cacheChapters = {}; // cacheChapters[version+'|'+bookName] = [ [ch,verses], ... ]

let state = {
  version: localStorage.getItem('bible_version') || 'KJV',
  bookIdx: Number(localStorage.getItem('bible_bookIdx') || 0),
  chapterIdx: Number(localStorage.getItem('bible_chapterIdx') || 0)
};
let fontSize = Number(localStorage.getItem('bible_font') || 18);

/* ---------------- DOM refs ---------------- */
const versionSelect = document.getElementById('versionSelect');
const bookSelect = document.getElementById('bookSelect');
const chaptersList = document.getElementById('chaptersList');
const versesList = document.getElementById('versesList');
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');
const loadingOverlay = document.getElementById('loadingOverlay');

/* ---------------- TTS language mapping (short -> BCP-47 prefix) ----------------
   These are helpful suggestions to pick the right voice. Browser may not have
   all voices; code will gracefully fall back to default voice when none match.
*/
const LANG_MAP = {
  AMP: 'en-US', CSB: 'en-US', ESV: 'en-US', KJV: 'en-US', NKJV: 'en-US', NIV: 'en-US', NLT: 'en-US',
  Bengali: 'bn', Gujarati: 'gu', Hindi: 'hi', Kannada: 'kn', Malayalam: 'ml', Nepali: 'ne', Odia: 'or', Punjabi: 'pa', Tamil: 'ta', Telugu: 'te',
  Afrikaans: 'af', Hungarian: 'hu', Indonesian: 'id', Sepedi: 'nso', Xhosa: 'xh', Zulu: 'zu'
};

/* ---------------- speech helpers ---------------- */
function getAvailableVoices(){
  return speechSynthesis.getVoices() || [];
}
function chooseVoiceForLang(prefix){
  const voices = getAvailableVoices();
  if(!prefix) return null;
  // try exact lang startsWith, then contains
  let v = voices.find(x => x.lang && x.lang.toLowerCase().startsWith(prefix.toLowerCase()));
  if(!v) v = voices.find(x => x.lang && x.lang.toLowerCase().includes(prefix.toLowerCase()));
  return v || null;
}

/* ---------------- Loading UI ---------------- */
function showLoading(show){
  loadingOverlay.classList.toggle('show', !!show);
  loadingOverlay.setAttribute('aria-hidden', !show);
}

/* ---------------- Stable-order helpers ---------------- */
function getBooksArray(version){
  if(cacheBooks[version]) return cacheBooks[version];
  const raw = loaded[version] || {};
  const arr = Object.entries(raw); // preserves parser order
  cacheBooks[version] = arr;
  return arr;
}
function getChaptersArray(version, bookName){
  const key = version + '|' + bookName;
  if(cacheChapters[key]) return cacheChapters[key];
  const bookData = (loaded[version] || {})[bookName] || {};
  const arr = Object.entries(bookData);
  cacheChapters[key] = arr;
  return arr;
}

/* ---------------- Lazy-load JSON ---------------- */
async function loadVersionIfNeeded(version){
  if(loaded[version]) return;
  const file = VERSION_FILES[version];
  showLoading(true);
  try{
    const res = await fetch(file);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    loaded[version] = j;
    cacheBooks[version] = Object.entries(j);
  }catch(err){
    console.error('Failed loading', version, err);
    loaded[version] = {};
  }finally{
    showLoading(false);
  }
}

/* ---------------- Version dropdown grouped ---------------- */
function populateVersions(){
  versionSelect.innerHTML = '';

  // English
  const eng = document.createElement('optgroup'); eng.label = 'English Versions';
  ['AMP','CSB','ESV','KJV','NKJV','NIV','NLT'].forEach(v => {
    if(VERSION_FILES[v]) { const o=document.createElement('option'); o.value=v; o.textContent=v; eng.appendChild(o); }
  });
  versionSelect.appendChild(eng);

  // Indian
  const ind = document.createElement('optgroup'); ind.label = 'Indian Languages';
  ['Bengali','Gujarati','Hindi','Kannada','Malayalam','Nepali','Odia','Punjabi','Tamil','Telugu'].forEach(v => {
    if(VERSION_FILES[v]) { const o=document.createElement('option'); o.value=v; o.textContent=v; ind.appendChild(o); }
  });
  versionSelect.appendChild(ind);

  // Other
  const oth = document.createElement('optgroup'); oth.label = 'Other Languages';
  ['Afrikaans','Hungarian','Indonesian','Sepedi','Xhosa','Zulu'].forEach(v => {
    if(VERSION_FILES[v]) { const o=document.createElement('option'); o.value=v; o.textContent=v; oth.appendChild(o); }
  });
  versionSelect.appendChild(oth);

  if(!(state.version in VERSION_FILES)) state.version = versionSelect.options[0].value;
  versionSelect.value = state.version;
}

/* ---------------- Books / Chapters / Verses ---------------- */
function populateBooks(){
  bookSelect.innerHTML = '';
  const books = getBooksArray(state.version);
  books.forEach(([bookName], idx)=>{
    const o = document.createElement('option'); o.value = idx; o.textContent = bookName; bookSelect.appendChild(o);
  });
  if(state.bookIdx >= books.length) state.bookIdx = Math.max(0, books.length - 1);
  bookSelect.value = state.bookIdx;
}

function populateChapters(){
  chaptersList.innerHTML = '';
  const books = getBooksArray(state.version);
  const [bookName, bookData] = books[state.bookIdx] || [null, {}];
  const chapters = getChaptersArray(state.version, bookName);
  chapters.forEach(([ch], idx)=>{
    const d = document.createElement('div');
    d.className = 'chapter-item';
    d.textContent = 'Chapter ' + ch;
    if(idx === state.chapterIdx) d.classList.add('active');
    d.addEventListener('click', ()=>{
      state.chapterIdx = idx;
      populateChapters();
      renderVerses();
      saveState();
    });
    chaptersList.appendChild(d);
  });
}

function renderVerses(){
  versesList.innerHTML = '';
  const books = getBooksArray(state.version);
  const [bookName, bookData] = books[state.bookIdx] || [null, {}];
  const chapters = getChaptersArray(state.version, bookName);
  const [chapterName, verses] = chapters[state.chapterIdx] || [null, {}];
  if(!verses){ versesList.textContent = 'No verses'; return; }
  Object.entries(verses).forEach(([vnum, text])=>{
    const div = document.createElement('div');
    div.className = 'verse';
    div.style.fontSize = fontSize + 'px';
    div.innerHTML = `<span class="vnum">${vnum}</span> ${text}`;
    versesList.appendChild(div);
  });
  saveState();
}

/* ---------------- Save state ---------------- */
function saveState(){
  localStorage.setItem('bible_version', state.version);
  localStorage.setItem('bible_bookIdx', state.bookIdx);
  localStorage.setItem('bible_chapterIdx', state.chapterIdx);
  localStorage.setItem('bible_font', fontSize);
}

/* ---------------- Event handlers ---------------- */
versionSelect.addEventListener('change', async ()=>{
  state.version = versionSelect.value;
  state.bookIdx = 0; state.chapterIdx = 0;
  await loadVersionIfNeeded(state.version);
  populateBooks();
  populateChapters();
  renderVerses();
  saveState();
});

bookSelect.addEventListener('change', ()=>{
  state.bookIdx = Number(bookSelect.value);
  state.chapterIdx = 0;
  populateChapters();
  renderVerses();
  saveState();
});

/* --------------- Font controls --------------- */
document.getElementById('fontUp').addEventListener('click', ()=>{
  fontSize = Math.min(30, fontSize + 2);
  document.querySelectorAll('.verse').forEach(v => v.style.fontSize = fontSize + 'px');
  saveState();
});
document.getElementById('fontDown').addEventListener('click', ()=>{
  fontSize = Math.max(12, fontSize - 2);
  document.querySelectorAll('.verse').forEach(v => v.style.fontSize = fontSize + 'px');
  saveState();
});

/* --------------- TTS Engine (auto-language voice) --------------- */
let ttsIndex = null;
let ttsLines = [];
let ttsUtter = null;
let isPaused = false;

// Prepare voices list (some browsers load voices asynchronously)
let VOICES = [];
function refreshVoices(){
  VOICES = speechSynthesis.getVoices() || [];
}
refreshVoices();
if (typeof speechSynthesis !== 'undefined') {
  speechSynthesis.onvoiceschanged = refreshVoices;
}

// choose best voice by LANG_MAP prefix
function pickVoiceForVersion(versionKey){
  const prefix = LANG_MAP[versionKey] || LANG_MAP[versionKey] === '' ? LANG_MAP[versionKey] : null;
  if(!VOICES || VOICES.length === 0) refreshVoices();
  if(!prefix) return null;
  const p = prefix.toLowerCase();
  // try to match voice.lang starting with prefix
  let v = VOICES.find(x => x.lang && x.lang.toLowerCase().startsWith(p));
  if(!v) v = VOICES.find(x => x.lang && x.lang.toLowerCase().includes(p));
  return v || null;
}

function speakNext(){
  if(ttsIndex === null || ttsIndex >= ttsLines.length) { ttsIndex = null; return; }
  const text = ttsLines[ttsIndex];
  if(!text) { ttsIndex = null; return; }

  ttsUtter = new SpeechSynthesisUtterance(text);
  ttsUtter.rate = 1.0;
  ttsUtter.pitch = 1.0;
  ttsUtter.volume = 1.0;

  // choose voice
  const v = pickVoiceForVersion(state.version);
  if(v) ttsUtter.voice = v;
  // also set lang if we have mapping
  const langPrefix = LANG_MAP[state.version];
  if(langPrefix) ttsUtter.lang = langPrefix;

  ttsUtter.onend = function(){
    if(isPaused) return;
    ttsIndex++;
    if(ttsIndex < ttsLines.length) {
      speakNext();
    } else {
      ttsIndex = null;
    }
  };

  speechSynthesis.speak(ttsUtter);
}

function startTTS(){
  // gather current visible verses (no auto-scroll)
  ttsLines = Array.from(document.querySelectorAll('.verse')).map(el => el.innerText);
  if(ttsLines.length === 0) return;
  // reset
  speechSynthesis.cancel();
  isPaused = false;
  ttsIndex = 0;
  // ensure voices available, then speak
  refreshVoices();
  speakNext();
}

function pauseTTS(){
  isPaused = true;
  speechSynthesis.pause();
}
function resumeTTS(){
  if(!ttsIndex && ttsLines.length === 0) return startTTS();
  isPaused = false;
  speechSynthesis.resume();
}
function stopTTS(){
  isPaused = false;
  ttsIndex = null;
  ttsLines = [];
  speechSynthesis.cancel();
}

/* wire TTS to buttons */
document.getElementById('playBtn').addEventListener('click', startTTS);
document.getElementById('pauseBtn').addEventListener('click', pauseTTS);
document.getElementById('resumeBtn').addEventListener('click', resumeTTS);
document.getElementById('stopBtn').addEventListener('click', stopTTS);

/* --------------- Search (debounced) --------------- */
let searchTimer = null;
searchInput && searchInput.addEventListener('input', ()=>{
  clearTimeout(searchTimer);
  searchTimer = setTimeout(()=> runSearch(searchInput.value.trim()), 250);
});
function runSearch(q){
  searchResults.innerHTML = '';
  if(!q) return;
  if(!loaded[state.version]) { searchResults.textContent = 'Load a version first to search.'; return; }
  const data = loaded[state.version] || {};
  const lc = q.toLowerCase();
  for(const [book, bookObj] of Object.entries(data)){
    for(const [ch, verses] of Object.entries(bookObj)){
      for(const [vnum, text] of Object.entries(verses)){
        if(text && text.toLowerCase().includes(lc)){
          const d = document.createElement('div');
          d.className = 'verse';
          d.innerHTML = `<strong>${book} ${ch}:${vnum}</strong> — ${text}`;
          searchResults.appendChild(d);
        }
      }
    }
  }
}

/* --------------- Page navigation --------------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(btn.dataset.page).classList.add('active');
  });
});

/* --------------- Init UI (auto-load last version) --------------- */
(async function init(){
  populateVersions();
  // load last used version automatically for convenience
  await loadVersionIfNeeded(state.version);
  populateBooks();
  populateChapters();
  renderVerses();
  // set selects to saved state
  versionSelect.value = state.version;
  bookSelect.value = state.bookIdx;
})();
</script>
</body>
</html>
