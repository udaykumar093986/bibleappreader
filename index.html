<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible App</title>
<link rel="icon" type="image/png" href="A_2D_digital_vector_illustration_features_a_Bible_.jpg">

<style>
  :root{
    --primary:#007aff;
    --border:#e6e6e6;
    --panel:#fafafa;
    --bg:#fff;
    --text:#111;
    --max-width:1180px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    background:var(--bg);
    color:var(--text);
    padding:12px;
  }
  .wrap{
    max-width:var(--max-width);
    margin:0 auto;
    background:#f7f7fb;
    border-radius:12px;
    padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.06);
  }
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:48px;height:48px;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:700}
  .small{font-size:13px;color:#666}

  nav{display:flex;gap:8px}
  .nav-btn{
    padding:8px 12px;border-radius:10px;border:1px solid transparent;
    background:transparent;cursor:pointer;font-weight:600
  }
  .nav-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

  /* FIX: Only the active page is visible */
  .page { display:none !important; }
  .page.active { display:block !important; }

  .home-title{
    text-align:center;padding:80px 0;font-size:28px;font-weight:700
  }

  /* Top controls */
  .top-row{
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px;
  }
  select{
    padding:10px 34px 10px 12px;border-radius:10px;border:1px solid var(--border);
    background:#fff;appearance:none;cursor:pointer;
  }
  .btn{
    padding:8px 12px;border-radius:10px;border:1px solid var(--border);
    background:#fff;cursor:pointer;font-weight:700
  }
  #audioBar{display:flex;gap:8px;margin-left:auto;align-items:center}

  /* Reader Columns */
  .reader{
    display:grid;
    grid-template-columns:300px 1fr;
    gap:14px;
  }
  .panel{
    background:var(--panel);
    padding:12px;border-radius:10px;border:1px solid var(--border);
    min-height:360px;display:flex;flex-direction:column
  }

  /* Chapters */
  #chaptersList{
    overflow:auto;padding-right:6px;
    display:flex;flex-direction:column;
  }
  .chapter-item{
    padding:10px;border-radius:8px;margin-bottom:8px;
    cursor:pointer;font-family:Georgia,serif
  }
  .chapter-item.active{
    background:var(--primary);color:#fff;font-weight:600
  }

  /* Verses */
  #versesList{
    overflow:auto;padding-right:6px;flex:1
  }
  .verse{
    padding:12px;border-radius:8px;border:1px solid var(--border);
    margin-bottom:10px;font-family:"Times New Roman",serif;
    font-size:18px;line-height:1.45
  }
  .vnum{
    font-weight:700;margin-right:8px
  }

  /* Search */
  .search-input{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px
  }

  /* Loading Overlay */
  .loadingOverlay{
    position:fixed;left:0;right:0;top:0;bottom:0;
    display:none;align-items:center;justify-content:center;
    background:rgba(255,255,255,0.6);z-index:9999
  }
  .loadingOverlay.show{display:flex}
  .loader{
    padding:12px 18px;border-radius:10px;background:#fff;
    border:1px solid var(--border);box-shadow:0 6px 18px rgba(0,0,0,0.06)
  }

  /* Mobile Responsive */
  @media (max-width:900px){
    .reader{ display:block; }
    
    /* Chapters scroll horizontally on mobile */
    #chaptersList{
      display:flex;flex-direction:row;gap:8px;
      overflow-x:auto; padding-bottom:8px;white-space:nowrap;
      max-height:none;
    }
    .chapter-item{
      min-width:110px;margin-bottom:0;display:inline-block;
    }
    #versesList{ max-height:60vh; }
    #audioBar{ margin-left:0; }
  }

  @media (max-width:420px){
    .logo{width:42px;height:42px}
    .title{font-size:16px}
    .btn{padding:6px 10px}
    select{padding:8px 30px 8px 10px}
    .verse{font-size:16px}
  }
</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">
        <img src="A_2D_digital_vector_illustration_features_a_Bible_.jpg">
      </div>
      <div>
        <div class="title">Bible App</div>
      </div>
    </div>

    <nav>
      <button class="nav-btn active" data-page="home">Home</button>
      <button class="nav-btn" data-page="reader">Reader</button>
      <button class="nav-btn" data-page="search">Search</button>
    </nav>
  </header>

  <!-- HOME -->
  <section id="home" class="page active">
    <div class="home-title">Welcome to the Bible App</div>
  </section>

  <!-- READER -->
  <section id="reader" class="page">
    <div class="top-row">
      <select id="versionSelect"></select>
      <select id="bookSelect"></select>

      <button class="btn" id="fontUp">A+</button>
      <button class="btn" id="fontDown">A−</button>

      <div id="audioBar">
        <button class="btn" id="playBtn">Play</button>
        <button class="btn" id="pauseBtn">Pause</button>
        <button class="btn" id="resumeBtn">Resume</button>
        <button class="btn" id="stopBtn">Stop</button>
      </div>
    </div>

    <div class="reader">
      <aside class="panel">
        <h3>Chapters</h3>
        <div id="chaptersList"></div>
      </aside>

      <section class="panel">
        <h3>Verses</h3>
        <div id="versesList"></div>
      </section>
    </div>
  </section>

  <!-- SEARCH -->
  <section id="search" class="page">
    <h3>Search</h3>
    <input id="searchInput" class="search-input" placeholder="Search words or reference (e.g. John 3:16)">
    <div id="searchResults"></div>
  </section>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loadingOverlay">
  <div class="loader">Loading version…</div>
</div>

<script>
/* --------------------------------------------------
   VERSION FILES
----------------------------------------------------- */
const VERSION_FILES = {
  AMP:'AMP_bible.json', CSB:'CSB_bible.json', ESV:'ESV_bible.json',
  KJV:'KJV_bible.json', NKJV:'NKJV_bible.json', NIV:'NIV_bible.json', NLT:'NLT_bible.json',

  Bengali:'bengali_bible.json', Gujarati:'gujarati_bible.json', Hindi:'hindi_bible.json',
  Kannada:'kannada_bible.json', Malayalam:'malayalam_bible.json', Nepali:'nepali_bible.json',
  Odia:'odia_bible.json', Punjabi:'punjabi_bible.json', Tamil:'tamil_bible.json', Telugu:'telugu_bible.json',

  Afrikaans:'afrikaans_bible.json', Hungarian:'hungarian_bible.json', Indonesian:'indonesian_bible.json',
  Sepedi:'sepedi_bible.json', Xhosa:'xhosa_bible.json', Zulu:'zulu_bible.json'
};

/* --------------------------------------------------
   STATE
----------------------------------------------------- */
const loaded = {};
let state = {
  version: localStorage.getItem('bible_version') || 'KJV',
  bookIdx: Number(localStorage.getItem('bible_bookIdx') || 0),
  chapterIdx: Number(localStorage.getItem('bible_chapterIdx') || 0)
};
let fontSize = Number(localStorage.getItem('bible_font') || 18);

/* --------------------------------------------------
   DOM
----------------------------------------------------- */
const versionSelect = document.getElementById("versionSelect");
const bookSelect = document.getElementById("bookSelect");
const chaptersList = document.getElementById("chaptersList");
const versesList = document.getElementById("versesList");
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");
const loadingOverlay = document.getElementById("loadingOverlay");

/* --------------------------------------------------
   LANGUAGE MAP FOR TTS
----------------------------------------------------- */
const LANG_MAP = {
  AMP:'en-US', CSB:'en-US', ESV:'en-US', KJV:'en-US', NKJV:'en-US', NIV:'en-US', NLT:'en-US',

  Bengali:'bn', Gujarati:'gu', Hindi:'hi', Kannada:'kn', Malayalam:'ml', Nepali:'ne',
  Odia:'or', Punjabi:'pa', Tamil:'ta', Telugu:'te',

  Afrikaans:'af', Hungarian:'hu', Indonesian:'id', Sepedi:'nso',
  Xhosa:'xh', Zulu:'zu'
};

/* --------------------------------------------------
   HELPERS
----------------------------------------------------- */
function showLoading(v){ loadingOverlay.classList.toggle("show", v); }

/* preserve order */
function booksArr(v){ return Object.entries(loaded[v]||{}); }
function chapArr(v,bk){ return Object.entries((loaded[v]||{})[bk]||{}); }

async function loadVersionIfNeeded(v){
  if(loaded[v]) return;
  showLoading(true);
  try{
    let res = await fetch(VERSION_FILES[v]);
    loaded[v] = await res.json();
  }catch(e){ loaded[v]={}; }
  showLoading(false);
}

function saveState(){
  localStorage.setItem("bible_version", state.version);
  localStorage.setItem("bible_bookIdx", state.bookIdx);
  localStorage.setItem("bible_chapterIdx", state.chapterIdx);
  localStorage.setItem("bible_font", fontSize);
}

/* --------------------------------------------------
   POPULATE VERSION DROPDOWN
----------------------------------------------------- */
function populateVersions(){
  versionSelect.innerHTML = "";

  const eng = document.createElement("optgroup");
  eng.label = "English Versions";
  ["AMP","CSB","ESV","KJV","NKJV","NIV","NLT"].forEach(v=>{
    if(VERSION_FILES[v]){
      let o=document.createElement("option");
      o.value=v;o.textContent=v;
      eng.appendChild(o);
    }
  });
  versionSelect.appendChild(eng);

  const ind = document.createElement("optgroup");
  ind.label = "Indian Languages";
  ["Bengali","Gujarati","Hindi","Kannada","Malayalam","Nepali","Odia","Punjabi","Tamil","Telugu"]
  .forEach(v=>{
    if(VERSION_FILES[v]){
      let o=document.createElement("option");
      o.value=v;o.textContent=v;
      ind.appendChild(o);
    }
  });
  versionSelect.appendChild(ind);

  const oth = document.createElement("optgroup");
  oth.label = "Other Languages";
  ["Afrikaans","Hungarian","Indonesian","Sepedi","Xhosa","Zulu"].forEach(v=>{
    if(VERSION_FILES[v]){
      let o=document.createElement("option");
      o.value=v;o.textContent=v;
      oth.appendChild(o);
    }
  });
  versionSelect.appendChild(oth);

  versionSelect.value = state.version;
}

/* --------------------------------------------------
   POPULATE BOOKS / CHAPTERS / VERSES
----------------------------------------------------- */
function populateBooks(){
  bookSelect.innerHTML = "";
  let arr = booksArr(state.version);
  arr.forEach(([name],i)=>{
    let o=document.createElement("option");
    o.value=i; o.textContent=name;
    bookSelect.appendChild(o);
  });
  if(state.bookIdx >= arr.length) state.bookIdx = 0;
  bookSelect.value = state.bookIdx;
}

function populateChapters(){
  chaptersList.innerHTML = "";
  let arr = booksArr(state.version);
  let [bookName] = arr[state.bookIdx] || [null];
  let chs = chapArr(state.version, bookName);

  chs.forEach(([ch],i)=>{
    let div=document.createElement("div");
    div.className="chapter-item";
    div.textContent="Chapter "+ch;
    if(i===state.chapterIdx) div.classList.add("active");

    div.onclick=()=>{
      state.chapterIdx=i;
      populateChapters();
      renderVerses();
      saveState();
    };

    chaptersList.appendChild(div);
  });
}

function renderVerses(){
  versesList.innerHTML = "";
  let arr = booksArr(state.version);
  let [bookName] = arr[state.bookIdx] || [null];
  let chs = chapArr(state.version, bookName);
  let [chapterName, verses] = chs[state.chapterIdx] || [null,{}];

  if(!verses){ versesList.textContent="No verses"; return; }

  Object.entries(verses).forEach(([vnum,text])=>{
    let div=document.createElement("div");
    div.className="verse";
    div.style.fontSize=fontSize+"px";
    div.innerHTML=`<span class="vnum">${vnum}</span> ${text}`;
    versesList.appendChild(div);
  });
  saveState();
}

/* --------------------------------------------------
   DROPDOWN EVENTS
----------------------------------------------------- */
versionSelect.onchange = async ()=>{
  state.version = versionSelect.value;
  state.bookIdx = 0;
  state.chapterIdx = 0;
  await loadVersionIfNeeded(state.version);
  populateBooks();
  populateChapters();
  renderVerses();
};
bookSelect.onchange = ()=>{
  state.bookIdx = Number(bookSelect.value);
  state.chapterIdx = 0;
  populateChapters();
  renderVerses();
};

/* --------------------------------------------------
   FONT
----------------------------------------------------- */
document.getElementById("fontUp").onclick = ()=>{
  fontSize = Math.min(30, fontSize+2);
  document.querySelectorAll(".verse").forEach(v=>v.style.fontSize=fontSize+"px");
  saveState();
};
document.getElementById("fontDown").onclick = ()=>{
  fontSize = Math.max(12, fontSize-2);
  document.querySelectorAll(".verse").forEach(v=>v.style.fontSize=fontSize+"px");
  saveState();
};

/* --------------------------------------------------
   TTS ENGINE (Auto Voice)
----------------------------------------------------- */
let VOICES=[];
function refreshVoices(){ VOICES=speechSynthesis.getVoices(); }
refreshVoices();
if(speechSynthesis.onvoiceschanged!==undefined)
  speechSynthesis.onvoiceschanged=refreshVoices;

let ttsIndex=null;
let ttsLines=[];
let isPaused=false;

function pickVoiceForVersion(vkey){
  let prefix = LANG_MAP[vkey] || "";
  if(!prefix) return null;
  prefix = prefix.toLowerCase();

  let v = VOICES.find(x=>x.lang && x.lang.toLowerCase().startsWith(prefix));
  if(!v) v = VOICES.find(x=>x.lang && x.lang.toLowerCase().includes(prefix));
  return v||null;
}

function speakNext(){
  if(ttsIndex===null || ttsIndex>=ttsLines.length){
    ttsIndex=null;return;
  }
  let text = ttsLines[ttsIndex];
  let utter = new SpeechSynthesisUtterance(text);

  let voice = pickVoiceForVersion(state.version);
  if(voice) utter.voice=voice;
  let l = LANG_MAP[state.version];
  if(l) utter.lang=l;

  utter.rate=1; utter.pitch=1; utter.volume=1;

  utter.onend=()=>{
    if(isPaused) return;
    ttsIndex++;
    ttsIndex<ttsLines.length ? speakNext() : ttsIndex=null;
  };
  speechSynthesis.speak(utter);
}

function startTTS(){
  ttsLines = Array.from(document.querySelectorAll(".verse")).map(v=>v.innerText);
  if(ttsLines.length===0) return;
  speechSynthesis.cancel();
  isPaused=false;
  ttsIndex=0;
  speakNext();
}
function pauseTTS(){ isPaused=true; speechSynthesis.pause(); }
function resumeTTS(){ isPaused=false; speechSynthesis.resume(); }
function stopTTS(){ isPaused=false; ttsIndex=null; speechSynthesis.cancel(); }

/* Wire TTS Buttons */
playBtn.onclick=startTTS;
pauseBtn.onclick=pauseTTS;
resumeBtn.onclick=resumeTTS;
stopBtn.onclick=stopTTS;

/* --------------------------------------------------
   SEARCH
----------------------------------------------------- */
let searchTimer;
searchInput?.addEventListener("input",()=>{
  clearTimeout(searchTimer);
  searchTimer=setTimeout(()=>runSearch(searchInput.value.trim()),250);
});
function runSearch(q){
  searchResults.innerHTML="";
  if(!q) return;
  if(!loaded[state.version]){
    searchResults.textContent="Load a version first.";
    return;
  }
  let data = loaded[state.version];
  let lc = q.toLowerCase();
  for(let [book,chap] of Object.entries(data)){
    for(let [ch,verses] of Object.entries(chap)){
      for(let [vnum,text] of Object.entries(verses)){
        if(text.toLowerCase().includes(lc)){
          let d=document.createElement("div");
          d.className="verse";
          d.innerHTML=`<strong>${book} ${ch}:${vnum}</strong> — ${text}`;
          searchResults.appendChild(d);
        }
      }
    }
  }
}

/* --------------------------------------------------
   NAVIGATION
----------------------------------------------------- */
document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(btn.dataset.page).classList.add("active");
  };
});

/* --------------------------------------------------
   INIT
----------------------------------------------------- */
(async function init(){
  populateVersions();
  await loadVersionIfNeeded(state.version);
  populateBooks();
  populateChapters();
  renderVerses();
  versionSelect.value = state.version;
  bookSelect.value = state.bookIdx;
})();
</script>

</body>
</html>
